name: Publish Image to Docker Hub

on:
  workflow_dispatch:
  schedule:
    - cron:  '0 0 * * 1'

jobs:
  all:
    runs-on: ubuntu-latest
    steps:
      - name: Repo checkout
        uses: actions/checkout@v4
      - name: Configure gituser
        uses: fregante/setup-git-user@v2
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: Update Python packages
        run: |
          uv pip compile requirements.in > requirements.txt
          git commit -am "Update requirements.txt" || true
      - name: Install R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '3.6.3'
      - name: Vers√µes dos pacotes R
        env:
          BITBUCKET_USER: ${{ secrets.BITBUCKET_USER }}
          BITBUCKET_PASSWORD: ${{ secrets.BITBUCKET_PASSWORD }}
        run: |
          Rscript -e "install.packages('renv', repos='https://cloud.r-project.org')"
          Rscript -e "options(renv.config.bitbucket.host = 'https://bitbucket.org')"
          Rscript -e "options(renv.config.bitbucket.auth_user = Sys.getenv('BITBUCKET_USER'))"
          Rscript -e "options(renv.config.bitbucket.password = Sys.getenv('BITBUCKET_PASSWORD'))"
          Rscript -e "renv::install(prompt = FALSE)"
          Rscript -e "renv::snapshot(prompt = FALSE)"
          git commit -am "Update renv.lock" || true
      - name: Get changed files
        id: changes
        uses: tj-actions/changed-files@v35
        with:
          files: |
            requirements.txt
            renv.lock
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        env:
          DOCKER_BUILDKIT: 1
          BITBUCKET_USER: ${{ secrets.BITBUCKET_USER }}
          BITBUCKET_PASSWORD: ${{ secrets.BITBUCKET_PASSWORD }}
        with:
          context: .
          push: true
          tags: splormg/${{ github.event.repository.name }}:latest
          cache-from: type=registry,ref=splormg/${{ github.event.repository.name }}:latest
          cache-to: type=inline
          secrets: |
            id=bitbucket_user,env=BITBUCKET_USER
            id=bitbucket_password,env=BITBUCKET_PASSWORD
      - name: Push files to repo
        run: |
          git push origin 26_actions_dockerimage
